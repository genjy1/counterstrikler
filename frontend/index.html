<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä "–£–≥–∞–¥–∞–π –∏–≥—Ä–æ–∫–∞"</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900 p-6">

<div class="max-w-2xl mx-auto bg-white shadow rounded p-6">
    <h1 class="text-2xl font-bold mb-4">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä "–£–≥–∞–¥–∞–π –∏–≥—Ä–æ–∫–∞"</h1>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div id="joinForm" class="mb-4">
        <input type="text" id="nicknameInput" placeholder="–í–∞—à –Ω–∏–∫" class="border p-2 rounded w-full mb-2">
        <input type="text" id="roomInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" class="border p-2 rounded w-full mb-2">
        <button id="joinBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    </div>

    <!-- –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ -->
    <div id="game" class="hidden">
        <div class="mb-4">
            <input type="text" id="guessInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏–≥—Ä–æ–∫–∞" class="border p-2 rounded w-full mb-2">
            <button id="guessBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 w-full">–£–≥–∞–¥–∞—Ç—å</button>
        </div>

        <div id="messages" class="mb-4 space-y-2"></div>

        <h2 class="text-xl font-bold mb-2">–¢–∞–±–ª–∏—Ü–∞ –∏–≥—Ä–æ–∫–æ–≤</h2>
        <table class="table-auto w-full border-collapse border border-gray-300">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-gray-300 px-2 py-1">–ò–≥—Ä–æ–∫</th>
                    <th class="border border-gray-300 px-2 py-1">–ü–æ–ø—ã—Ç–∫–∏</th>
                    <th class="border border-gray-300 px-2 py-1">–û—á–∫–∏</th>
                </tr>
            </thead>
            <tbody id="leaderboard"></tbody>
        </table>

        <div id="playerPhoto" class="mt-4"></div>
    </div>
</div>

<script>
let ws;
let room;
let nickname;

// –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function connect() {
    ws = new WebSocket('ws://localhost:8080');

    ws.onopen = () => {
        console.log('WebSocket –æ—Ç–∫—Ä—ã—Ç');

        // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è
        const savedNick = localStorage.getItem('nickname');
        const savedRoom = localStorage.getItem('room');
        if (savedNick && savedRoom) {
            nickname = savedNick;
            room = savedRoom;
            ws.send(JSON.stringify({type:'join', room, nickname}));
        }
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log(data);

        if (data.type === 'connected') {
            addMessage(data.message);
        } else if (data.type === 'joined') {
            showGame();
            updateLeaderboard(data.leaderboard);
        } else if (data.type === 'update') {
            updateLeaderboard(data.leaderboard);
            if (data.correct && data.player === nickname) {
                addMessage(`üéâ –í—ã —É–≥–∞–¥–∞–ª–∏! –≠—Ç–æ –±—ã–ª ${data.answer}`);
                if (data.photo) showPhoto(data.photo);
            }
        }
    };

    ws.onclose = () => console.log('WebSocket –∑–∞–∫—Ä—ã—Ç');
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
document.getElementById('joinBtn').onclick = () => {
    nickname = document.getElementById('nicknameInput').value.trim();
    room = document.getElementById('roomInput').value.trim();
    if (!nickname || !room) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ ID –∫–æ–º–Ω–∞—Ç—ã!');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
    localStorage.setItem('nickname', nickname);
    localStorage.setItem('room', room);

    ws.send(JSON.stringify({type:'join', room, nickname}));
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≥–∞–¥—ã–≤–∞–Ω–∏—è
document.getElementById('guessBtn').onclick = () => {
    const guess = document.getElementById('guessInput').value.trim();
    if (!guess) return;
    guessPlayer(guess);
};

function guessPlayer(guess) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
        return;
    }
    ws.send(JSON.stringify({type:'guess', room, nickname, guess}));
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ç–æ –∏–≥—Ä–æ–∫–∞
function showPhoto(url) {
    const container = document.getElementById('playerPhoto');
    container.innerHTML = `<img src="${url}" alt="–§–æ—Ç–æ –∏–≥—Ä–æ–∫–∞" class="max-w-xs rounded shadow">`;
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
function addMessage(msg) {
    const container = document.getElementById('messages');
    const p = document.createElement('p');
    p.textContent = msg;
    p.className = 'bg-gray-100 p-2 rounded shadow';
    container.appendChild(p);
}

// –ü–æ–∫–∞–∑ –∏–≥—Ä–æ–≤–æ–π –∑–æ–Ω—ã
function showGame() {
    document.getElementById('joinForm').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
function updateLeaderboard(players) {
    const tbody = document.getElementById('leaderboard');
    tbody.innerHTML = '';
    for (const [nick, stats] of Object.entries(players)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="border border-gray-300 px-2 py-1">${nick}</td>
            <td class="border border-gray-300 px-2 py-1">${stats.tries}</td>
            <td class="border border-gray-300 px-2 py-1">${stats.score}</td>
        `;
        tbody.appendChild(tr);
    }
}

// –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.onload = () => connect();
</script>

</body>
</html>
